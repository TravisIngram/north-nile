angular.module("northApp").controller("MapController",["Upload","ngAudio","ResourceFactory","UserTrackFactory","$scope","leafletData","leafletMarkerEvents","$mdDialog","$http","$location",function(a,b,c,d,e,f,g,h,i,j){var k=this,l=d.getUserData();l.then(function(a){k.user=a.data}),k.routeUser=function(){k.user.is_admin===!0?j.path("/admin"):j.path("/user")};var m={iconUrl:"assets/img/GardenBlueBorder.svg",iconSize:[38,38],shadowSize:[50,64],iconAnchor:[19,19],shadowAnchor:[4,62],popupAnchor:[-3,-76]},n={iconUrl:"assets/img/CulinaryRedBorder.svg",iconSize:[38,38],shadowSize:[50,64],iconAnchor:[19,19],shadowAnchor:[4,62],popupAnchor:[-3,-76]},o={iconUrl:"assets/img/StoreYellowBorder.svg",iconSize:[38,38],shadowSize:[50,64],iconAnchor:[19,19],shadowAnchor:[4,62],popupAnchor:[-3,-76]},p={iconUrl:"assets/img/GreenHousePerfect.svg",iconSize:[38,38],shadowSize:[50,64],iconAnchor:[19,19],shadowAnchor:[4,62],popupAnchor:[-3,-76]};k.storedMarkers=c.mapResources,k.newResource={city_name:"Minneapolis",state:"MN"},k.markerSize=Object.keys(k.storedMarkers).length,k.count=k.markerSize+1,k.visibleMarkers={},k.filterMarkers=function(a,b){k.visibleMarkers={};var c=angular.element(document.querySelector("#filter1")),d=angular.element(document.querySelector("#filter2")),e=angular.element(document.querySelector("#filter3")),f=angular.element(document.querySelector("#filter4"));switch(a){case"Community Garden":c.toggleClass("disabledKeyButton"),console.log("filter1:",c);break;case"Culinary Arts":d.toggleClass("disabledKeyButton");break;case"Food Distribution":e.toggleClass("disabledKeyButton");break;case"Food Hub":f.toggleClass("disabledKeyButton")}if("all"===a)for(marker in k.storedMarkers)k.storedMarkers[marker].visibility=!0,"Community Garden"==k.storedMarkers[marker].resource_type&&(k.storedMarkers[marker].icon=m),"Culinary Arts"==k.storedMarkers[marker].resource_type&&(k.storedMarkers[marker].icon=n),"Food Distribution"==k.storedMarkers[marker].resource_type&&(k.storedMarkers[marker].icon=o),"Food Hub"==k.storedMarkers[marker].resource_type&&(k.storedMarkers[marker].icon=p);else if("none"===a)for(marker in k.storedMarkers)k.storedMarkers[marker].visibility=!1;else for(marker in k.storedMarkers)k.storedMarkers[marker].resource_type===a&&(k.storedMarkers[marker].visibility=!k.storedMarkers[marker].visibility);for(marker in k.storedMarkers)k.storedMarkers[marker].visibility&&(k.visibleMarkers["m"+k.count]=k.storedMarkers[marker],k.count++);angular.extend(k,{markers:k.visibleMarkers})},k.lastClicked={},k.openInfoDrawer=function(a,c){k.showInfoDrawer=!0,k.showNewResourceDrawer=!1,console.log("mc.lastClicked",k.lastClicked),k.lastClicked=c.model,"Community Garden"==k.lastClicked.resource_type&&(k.colorBk="resourceBlue"),"Culinary Arts"==k.lastClicked.resource_type&&(k.colorBk="resourceOrange"),"Food Hub"==k.lastClicked.resource_type&&(k.colorBk="resourceGreen"),"Food Distribution"==k.lastClicked.resource_type&&(k.colorBk="resourceYellow"),k.webSocialShow=function(){return k.lastClicked.website||k.lastClicked.twitter||k.lastClicked.facebook||k.lastClicked.instagram||k.lastClicked.snapchat?!0:void 0},k.contactShow=function(){return k.lastClicked.leadership||k.lastClicked.public_phone||k.lastClicked.public_email||k.lastClicked.hours?!0:void 0},k.lastClicked.audio_reference&&(k.lastClicked.sound=b.load(k.lastClicked.audio_reference)),angular.extend(k,{center:{lat:k.lastClicked.lat,lng:k.lastClicked.lng,zoom:15}})},k.closeInfoDrawer=function(a,b){k.showInfoDrawer&&(k.showInfoDrawer=!1,angular.extend(k,{center:{lat:k.lastClicked.lat,lng:k.lastClicked.lng,zoom:15}}))},k.currentIndex=0,k.setCurrentSlideIndex=function(a){k.currentIndex=a},k.isCurrentSlideIndex=function(a){return k.currentIndex===a},k.prevSlide=function(){k.currentIndex=k.currentIndex<k.lastClicked.images.length-1?++k.currentIndex:0},k.nextSlide=function(){k.currentIndex=k.currentIndex>0?--k.currentIndex:k.lastClicked.images.length-1},k.play=function(a){console.log("audio play:",a),a.paused!==!0?a.pause():a.play()},k.stop=function(a){console.log("audio stop:",a),a.setCurrentTime(0),a.pause()},k.mute=function(){k.muted?(b.unmute(),k.muted=!1):(b.mute(),k.muted=!0)},k.saveResourceCoords=function(a,b){console.log("saving args:",b),k.newResource.latitude=b.leafletEvent.latlng.lat,k.newResource.longitude=b.leafletEvent.latlng.lng,k.newResource.lat=k.newResource.latitude,k.newResource.lng=k.newResource.longitude;var c="d757d21efc7d5efeb1195e398d031a5e";i.get("https://api.opencagedata.com/geocode/v1/json?q="+k.newResource.lat+","+k.newResource.lng+"&pretty=1&key="+c).then(function(a){var b={confidence:0};if(a.data.results.length>1){a.data.results.map(function(a){a.confidence>=b.confidence&&(b=a)});var c=b}else var c=a.data.results[0];console.log("Reverse geocode:",c),c.components.house_number?k.newResource.address_line1=c.components.house_number+" "+c.components.road:k.newResource.address_line1=c.components.road,c.components.city&&(k.newResource.city_name=c.components.city),c.components.state&&(k.newResource.state=c.components.state),c.components.postcode&&(k.newResource.zip_code=c.components.postcode)}),k.visibleMarkers.temp=k.newResource,angular.extend(k,{markers:k.visibleMarkers})},k.addNewResource=function(){k.showInfoDrawer=!1,k.showNewResourceDrawer?(k.newResource.account_id=k.user.id,k.showNewResourceDrawer=!1):(k.showNewResourceDrawer=!0,k.user?(k.showNewResourceForm=!0,k.showNewResourceLogin=!1,k.showNewResourceRegister=!1):(k.showNewResourceLogin=!0,k.showNewResourceRegister=!1,k.showNewResourceForm=!1))},c.getSavedResources(k.filterMarkers),e.$on("leafletDirectiveMarker.map.click",k.openInfoDrawer),e.$on("leafletDirectiveMap.map.click",k.closeInfoDrawer),e.$on("leafletDirectiveMap.map.contextmenu",k.saveResourceCoords),angular.extend(k,{defaults:{scrollWheelZoom:!1,touchZoom:!0,dragging:!0,tap:!0,tapTolerance:100},center:{lat:44.996121,lng:-93.295845,zoom:15},tiles:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"},markers:k.visibleMarkers}),k.loginUser=function(){i.post("/login",k.loginInfo).then(function(a){200==a.status&&(k.user=a.data,console.log("successful login",a.data.is_admin),a.data.is_admin===!0?(console.log("admin is true"),k.loginInfo={},k.showNewResourceLogin=!1,k.showNewResourceForm=!0):(console.log("admin is not true"),k.loginInfo={},k.showNewResourceLogin=!1,k.showNewResourceForm=!0))},function(a){function b(){alert=h.alert({title:"Attention",textContent:"Incorrect username and/or password. Please enter information again.",ok:"Close"}),h.show(alert)["finally"](function(){alert=void 0})}console.log("unsuccessful login"),b(),k.loginInfo={}})},k.registerShow=function(){k.showNewResourceLogin=!1,k.showNewResourceRegister=!0},k.loginShow=function(){k.showNewResourceLogin=!0,k.showNewResourceRegister=!1},k.registerInfo={},k.passwordMismatch=function(){return k.registerInfo.password!==k.registerInfo.confirm_password?!0:void 0},k.passwordMismatchError=function(){return k.passwordMismatch()&&k.registerFormInputs.confirm_password.$dirty?!0:void 0},k.registerUser=function(){i.post("/register",k.registerInfo).then(function(a){200==a.status&&(console.log("successful registration"),k.loginInfo={username:k.registerInfo.username},k.registerInfo={},k.showNewResourceRegister=!1,k.showNewResourceLogin=!0)},function(a){function b(){void 0===k.registerInfo.username?k.alertMessage="Username field cannot be blank":k.alertMessage="Username already exists, please choose another.",alert=h.alert({title:"Attention",textContent:k.alertMessage,ok:"Close"}),h.show(alert)["finally"](function(){alert=void 0})}console.log("unsuccessful registration"),b(),k.registerInfo.username=void 0})},k.uploadAudio=function(a){c.uploadAudio(a,k.updateAudioInfo)},k.updateAudioInfo=function(a,b){k.newResource.audio_id=a,k.newResource.audio_reference=b},k.removeAudio=function(a){c.removeAudio(a,k.clearAudioPath)},k.clearAudioPath=function(){k.newResource.audio_reference=""},k.newImagePaths=c.newImagePaths,k.uploadImage=function(a){c.uploadImage(a,k.updateImageInfo)},k.updateImageInfo=function(){for(path in k.newImagePaths.paths)console.log("path:",path),""==k.newImagePaths.paths[path]&&(k.newImagePaths.paths[path]="//:0");console.log("newImages:",k.newImagePaths.paths),k.newResource.image_id=k.newImagePaths.image_id,k.newResource.path1=k.newImagePaths.paths.path1,k.newResource.path2=k.newImagePaths.paths.path2,k.newResource.path3=k.newImagePaths.paths.path3,k.newResource.path4=k.newImagePaths.paths.path4,k.newResource.path5=k.newImagePaths.paths.path5},k.saveNewResource=function(a){k.showNewResourceForm,console.log("Saving new resource from user:",k.user),a.account_id=k.user.id,a.is_pending=!a.is_active,a.date_created=new Date,c.saveNewResource(a,k.user),k.showNewResourceDrawer=!1,k.newResource={},k.visibleMarkers.temp=k.newResource,angular.extend(k,{markers:k.visibleMarkers})},k.cancelNewResource=function(){k.showNewResourceDrawer=!1,k.newResource={},k.visibleMarkers.temp=k.newResource,angular.extend(k,{markers:k.visibleMarkers})},console.log("Map controller loaded.")}]);